{% extends "finale_base_edit.html" %}
{% block title %}Financial Lightweight Editor - Setup{% endblock %}
{% block readyoptions %}
				$(".btn").not('#comment').tooltip();
				containerChanged();
				gridster = $(".gridster ul").gridster({
					widget_margins: [10, 10],
					widget_base_dimensions: [340, 340],
					resize: {
						enabled: true,
						max_size: [4, 4],
						min_size: [1, 1]
					}
				}).data('gridster');
{% endblock %}
{% block headeroptions %}
<script>
	var allItems = {{global|safe}};
	var currentItem = 0;
	var emptyWidget = "<li id='gridjet_%%index%%'><div class='form-group'><button id='dismiss_%%index%%' class='col-lg-offset-10 col-lg-1' onclick='dismiss(%%index%%)' type='button'><span class='glyphicon glyphicon-remove' aria-hidden='true'></span></button></div><div class='form-group'><label for='title_%%index%%' class='control-label col-lg-2'>Title</label><div class='col-lg-9'><input name='title_%%index%%' id='title_%%index%%' type='text' class='form-control' placeholder='Input block title here'/></div></div><div class='form-group'><label for='type_%%index%%' class='control-label col-lg-2'>Type</label><div class='col-lg-9'><select id='type_%%index%%' name='type_%%index%%' class='form-control'></select></div></div><div class='form-group' id='content_%%index%%'></div></li>";
	var gridster;

	var allFieldsInformation;
	var allFields;
	var singleFields;
	var multipleFields;

	var remainingLoads = 0;
	var callbacks = [];

	var blockData = {};

	function onCallError(e) {
		alert(e.status);
	}

	function containerFieldsSaved(e) {

	}

	function dismiss(toRemove) {
		for(var index=0;index<currentItem;index++) {
			if (index==toRemove) {
				gridster.remove_widget($("#gridjet_" + index));
			} else if (index>toRemove) {
				$("#gridjet_" + index).find('[id]').each(function(index, node) {
					if ($(node).hasAttr('id')) {
						$(node).attr('id', $(node).attr('id').replace(index.toString(), (index-1).toString()));
					}
					if ($(node).hasAttr('name')) {
						$(node).attr('name', $(node).attr('name').replace(index.toString(), (index-1).toString()));
					}
				});
				$("#gridjet_" + index).attr('id', "gridjet_" + (index-1));
			}
		}
		currentItem -= 1;
	}

	function checkLoads() {
		remainingLoads -= 1;
		$.each(callbacks, function(index, f) {
			f();
		})
	}

	function completeSaveData() {
		for (var index=0;index<currentItem;index++) {
			var key = index.toString();
			if (!blockData.hasOwnProperty(key)) {
				blockData[key] = {"title": $("#title_" + key).val(), "type": $("#type_" + key).val(), "data": []};
			} else {
				blockData[key].title = $("#title_" + key).val();
				blockData[key].type = $("#type_" + key).val();
			}
			if (blockData[key].type=="LAYOUT_HISTORY_CHART" || blockData[key].type=="LAYOUT_DISTRIBUTION_CHART" || blockData[key].type=="LAYOUT_HISTORICAL_DISTRIBUTION_CHART") {
				blockData[key].data = {
					"track_type": $("#track_type_" + key).val(), "track_default": $("#track_default_" + key).prop("checked"), "track_frequency": $("#frequency_" + key).val(), "track_datasource":$("#datasource_" + key).val()
				}
			}
		}
	}

	function saveLayout() {
		var gridsterLayout = gridster.serialize();
		completeSaveData();
		var toSave = {"layout": gridsterLayout, "data": blockData};
		var containerSetup = {}
		containerSetup.type = $("#containerType").val();
		containerSetup.information = toSave;
		var updateForm = new FormData();
		console.log(containerSetup);
		updateForm.append('container_setup', JSON.stringify(containerSetup));
		updateForm.append('item',urlParams['item']);
		updateForm.append('type',urlParams['type']);
		updateForm.append('render_name','view');
		$.ajax({
			url: '/container_setup_save.html',
			type: 'POST',
			data: updateForm,
			processData: false,
			contentType: false,
			success: containerFieldsSaved,
			error: onCallError
		});
	}

	function trackDefaultChanged(index) {
		$("#frequency_" + index).prop('disabled', !$("#frequency_" + index).prop('disabled'));
		$("#datasource_" + index).prop('disabled', !$("#datasource_" + index).prop('disabled'));
	}

	function onForeignClick(index, fieldName) {
		var target = "#fieldsList_" + index + " > ";
		$(target + ".sub-" + fieldName).toggleClass("hidden");
	}

	function onMultipleFieldClick(index, fieldName) {
		var target = "#fieldsList_" + index + " > ";
		var key = index.toString();
		if (!blockData.hasOwnProperty(key)) {
			blockData[key] = {"title": $("#title_" + key).val(), "type": $("#type_" + key).val(), "data": []};
		}
		blockData[key].data = [fieldName];
		$(target + ".list-group-item-success").removeClass("list-group-item-success");
		$(target + ".main-" + fieldName).toggleClass("list-group-item-success");
	}

	function onFieldClick(index, fieldName) {
		var target = "#fieldsList_" + index + " > ";
		var key = index.toString();
		if (!blockData.hasOwnProperty(key)) {
			blockData[key] = {"title": $("#title_" + key).val(), "type": $("#type_" + key).val(), "data": []};
		}

		if (fieldName.indexOf(".")!==-1) {
			var mainField = fieldName.substring(0, fieldName.indexOf("."));
			var subField = fieldName.substring(fieldName.indexOf(".") + 1);
			$(target + ".main-" + mainField + ".multiple-master").removeClass("list-group-item-warning");
			if ($(target + ".main-" + subField + ".sub-" + mainField + ".list-group-item-info").length===1) {
				blockData[key].data.push(fieldName);
			} else {
				blockData[key].data.splice(blockData[key].data.indexOf(fieldName), 1);
			}
			$(target + ".main-" + subField + ".sub-" + mainField).toggleClass("list-group-item-success");
			$(target + ".main-" + subField + ".sub-" + mainField).toggleClass("list-group-item-info");
			if ($(target + ".sub-" + mainField + ".list-group-item-success").length>0) {
				$(target + ".main-" + mainField + ".multiple-master").addClass("list-group-item-warning");
			}
		} else {
			if ($(target + ".main-" + fieldName + ":not(.multiple-master)").hasClass("list-group-item-success")) {
				blockData[key].data.splice(blockData[key].data.indexOf(fieldName), 1);
			} else {
				blockData[key].data.push(fieldName);
			}
			$(target + ".main-" + fieldName + ":not(.multiple-slave)").toggleClass("list-group-item-success");
		}

	}

	function changeType(index) {
		var selectedType = $("#type_" + index).val();
		$("#content_" + index).empty();
		var htmlToAppend = "";
		var callLater = function() {};
		if (selectedType=="LAYOUT_OBJECT_TYPE_SINGLES") {
			htmlToAppend += "<div id='fieldsList_" + index + "' class='list-group col-lg-offset-1 col-lg-10 pre-scrollable' style='height: 195px;'>";
			$.each(singleFields, function(valueIndex, value) {
				if (allFieldsInformation[value].type.lastIndexOf("FIELD_TYPE_", 0)===0) {
					htmlToAppend += '<a class="list-group-item main-' + value + '" onclick="onFieldClick(' + index + ',\'' + value + '\')">' + value + '</a>';
				} else {
					htmlToAppend += '<a class="list-group-item multiple-master main-' + value + '" onclick="onForeignClick(' + index + ',\'' + value + '\')">' + value + '</a>';

					var subCurrentList = [];
					$.each(allFieldsInformation[value].fields, function(subIndex, subValue) {
						subCurrentList.push(subIndex);
					});
					subCurrentList.sort();
					$.each(subCurrentList, function (subIndex, subValue) {
						htmlToAppend += '<a class="list-group-item list-group-item-info multiple-slave hidden main-' + subValue + ' sub-' + value + '" onclick="onFieldClick(' + index + ',\'' + value + '.' + subValue + '\')">' + subValue + '</a>';
					});

				}
			});
			htmlToAppend += "</div>";
		} else if (selectedType=="LAYOUT_OBJECT_TYPE_LIST") {
			htmlToAppend += "<div id='fieldsList_" + index + "' class='list-group col-lg-offset-1 col-lg-10 pre-scrollable' style='height: 195px;'>";
			$.each(multipleFields, function(valueIndex, value) {
				htmlToAppend += '<a class="list-group-item main-' + value + '" onclick="onMultipleFieldClick(' + index + ',\'' + value + '\')">' + value + '</a>';
			});
			
			htmlToAppend += "</div>";
		} else if (selectedType=="LAYOUT_HISTORY_CHART" || selectedType=="LAYOUT_DISTRIBUTION_CHART" || selectedType=="LAYOUT_HISTORICAL_DISTRIBUTION_CHART") {
			htmlToAppend += "<div class='form-group'><label for='track_type_%%index%%' class='control-label col-lg-2'>Track type</label><div class='col-lg-9'><select id='track_type_%%index%%' name='track_type_%%index%%' class='form-control'></select></div></div>";
			htmlToAppend += "<div class='form-group'><div class='col-lg-offset-2'><div class='checkbox'><label for='track_default_%%index%%'><input id='track_default_%%index%%' name='track_default_%%index%%' type='checkbox' checked onchange='trackDefaultChanged(%%index%%)'> Use default source and frequency</label></div></div></div>";
			htmlToAppend += "<div class='form-group'><label for='frequency_%%index%%' class='control-label col-lg-2'>Frequency</label><div class='col-lg-9'><select id='frequency_%%index%%' name='frequency_%%index%%' class='form-control' disabled></select></div></div>";
			htmlToAppend += "<div class='form-group'><label for='datasource_%%index%%' class='control-label col-lg-2'>Data source</label><div class='col-lg-9'><select id='datasource_%%index%%' name='datasource_%%index%%' class='form-control' disabled></select></div></div>";
			htmlToAppend = htmlToAppend.replaceAll('%%index%%', index);
			
			callLater = function() {
				remainingLoads += 3;
				$("#frequency_" + index).load("/static/templates/frequency_select_en.html", checkLoads);
				$("#track_type_" + index).load("/static/templates/numeric_type_select_en.html", checkLoads);
				$("#datasource_" + index).load("/static/templates/data_source_select_en.html", checkLoads);
			};
		}
		$("#content_" + index).append(htmlToAppend);
		callLater();
	}
	
	function buildWidgets(savedLayout) {
		var currentInformation = allItems[$("#containerType").val()];
		remainingLoads -= 1;
		callbacks = [];
		blockData = {};
		if (currentInformation) {
			$.each(currentInformation.layout, function (index, savedLayout) {
				addWidget(savedLayout, function() {
					$("#title_" + index).val(currentInformation.data[index.toString()].title);
					$("#type_" + index).val(currentInformation.data[index.toString()].type);
					changeType(index);
				});
				callbacks.push(function() {
					if (currentInformation.data[index.toString()].type=='LAYOUT_OBJECT_TYPE_SINGLES') {
						$.each(currentInformation.data[index.toString()].data, function(fieldIndex, field) {
							onFieldClick(index, field);
						});
					} else if(currentInformation.data[index.toString()].type=='LAYOUT_OBJECT_TYPE_LIST') {
						$.each(currentInformation.data[index.toString()].data, function(fieldIndex, field) {
							onMultipleFieldClick(index, field);
						});
					} else if (currentInformation.data[index.toString()].type=='LAYOUT_HISTORY_CHART' || currentInformation.data[index.toString()].type=='LAYOUT_DISTRIBUTION_CHART' || currentInformation.data[index.toString()].type=='LAYOUT_HISTORICAL_DISTRIBUTION_CHART') {
						$("#track_default_" + index).prop('checked', currentInformation.data[index.toString()].data.track_default)
						$("#track_default_" + index).change();
						$("#frequency_" + index).val(currentInformation.data[index.toString()].data.track_frequency);
						$("#datasource_" + index).val(currentInformation.data[index.toString()].data.track_datasource);
						$("#track_type_" + index).val(currentInformation.data[index.toString()].data.track_type);
					}
				});
			});
		}
	}

	function addWidget(layout, callback) {
		gridster.add_widget.apply(gridster, [emptyWidget.replaceAll('%%index%%', currentItem),layout.size_x, layout.size_y]);
		var index = currentItem;
		$("#type_" + currentItem).load("/static/templates/layout_object_type_select_en.html", function() {
			changeType(index);
			callback();
		});
		$("#type_" + currentItem).attr('onchange','changeType(' + currentItem + ')');
		
		currentItem = currentItem + 1;
	}

	function fieldsLoaded(e) {
		allFieldsInformation = e.result;
		for (var index=currentItem-1;index>=0;index--) {
			gridster.remove_widget($('.gridster li').eq(index));
		}
		currentItem = 0;
		allFields = [];
		singleFields = [];
		multipleFields = [];

		$.each(e.result, function(index, value) {
			allFields.push(index);
		});
		allFields.sort();
		$.each(allFields, function(index, value) {
			if (e.result[value].type.lastIndexOf("FIELD_TYPE_", 0)===0) {
				singleFields.push(value);
			} else {
				if (e.result[value].type==='ForeignKey') {
					singleFields.push(value);
				} else {
					multipleFields.push(value);
				}
			}
		});

		buildWidgets();
	}

	function containerChanged() {
		initialLoad = true;
		var fieldsForm = new FormData();
		fieldsForm.append('container_type', $("#containerType").val());
		$.ajax({
			url: '/object_fields_get.html',
			type: 'POST',
			data: fieldsForm,
			processData: false,
			contentType: false,
			success: fieldsLoaded,
			error: onCallError
		});
	}

</script>
{% endblock %}
{% block content %}
		<div class="row">
			<div class="col-lg-11">
				<h1 class="">Details page definition</h1>
	  			<p class="lead">Define the information and layout of the details page.<br/>
			</div>
		</div>
		<div class="row">
			<select class="form-control no-enter" id="containerType" name="containerType" onchange="containerChanged()">
				{% with value='' %}
					{% include selection_template %}
				{% endwith %}
			</select>
			<b
		</div>
		<div class="row">&nbsp;</div>
		<div class="row">
			<button class="btn btn-default col-lg-3" type="button" data-placement="bottom" title="Create a new widget to the current layout" onclick='addWidget({"row": 1, "size_x": 1, "col": 1, "size_y": 1})'>Add</button>
			<button class="btn btn-default col-lg-offset-6 col-lg-3" type="button" data-placement="bottom" title="Save the current layout" onclick="saveLayout()">Save</button>
		</div>
		<div class="row">
			<form class="form-horizontal" role="form">
				<div id="layoutGrid" class="gridster col-lg-12">
					<ul id="layoutGridContent">
					</ul>
				</div>
			</form>
		</div>
{% endblock %}